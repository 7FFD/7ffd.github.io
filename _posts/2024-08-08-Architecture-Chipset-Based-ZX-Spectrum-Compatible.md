---
layout: post
title:   "Архітектура 'чіпсетних' спектрумів"
categories:
    - ZX Spectrum
    - Т34ВГ1
    - КА1515ХМ1-216
    - ULA
excerpt_separator: <!--more-->
---
Більшісіть клонів ZX Spectrum була розроблена на доступній в той час елементній базі. В середньому, вони мали від 40 до 80+ мікросхем логіки, яка приблизно повторювала поведінку ULA.  
Пізніше, щоб зменшити кількість мікросхем, чим спростити збирання і зменшити кількість помилок, були розроблені так звані 'БМК' - базовий матричний кристал. Такий підхід дав можливість "прошивати" БМК потрібною "схемою".

![Архітектура 'чіпсетних' спектрумів, вступ](/content/2024-08-08-Architecture-Chipset-Based-ZX-Spectrum-Compatible/00-T34VG1-9311-intro.jpg "Архітектура 'чіпсетних' спектрумів, вступ")

<!--more-->

## Історія появи

Історія створення "прошивки" для БМК залишається загадкою до сих пір. Кацапи кричать, що вони її розробили в зеленограді, чи десь там, крім того є декілька незрозумілих моментів, пов'язаних з словцькою компанією Didaktik Skalica.  
Залишаю на ваш розсуд робити висновки, але все виглядає так, що технологія була поцупана в ГДР разом з копією процесора  Z80 - UA880. До речі, перші комплекти ROM + КА1515ХМ1-216 + UA880 були з ГДРівським процесором :)

Варіації виконань чіпів Т34ВГ1-9312 і КА1515ХМ1-216

![Архітектура 'чіпсетних' спектрумів, Т34ВГ1-9312](/content/2024-08-08-Architecture-Chipset-Based-ZX-Spectrum-Compatible/01-T34VG1-9312.jpg "Архітектура 'чіпсетних' спектрумів, Т34ВГ1-9312")

![Архітектура 'чіпсетних' спектрумів, Т34ВГ1-9312](/content/2024-08-08-Architecture-Chipset-Based-ZX-Spectrum-Compatible/02-T34VG1-9312.jpg "Архітектура 'чіпсетних' спектрумів, Т34ВГ1-9312")

![Архітектура 'чіпсетних' спектрумів, Т34ВГ1-9312](/content/2024-08-08-Architecture-Chipset-Based-ZX-Spectrum-Compatible/03-T34VG1-9312.jpg "Архітектура 'чіпсетних' спектрумів, Т34ВГ1-9312")

Розпіновка чіпа виглядає так:

![Архітектура 'чіпсетних' спектрумів, Т34ВГ1 розпіновка](/content/2024-08-08-Architecture-Chipset-Based-ZX-Spectrum-Compatible/04-T34VG1-pinout.png "Архітектура 'чіпсетних' спектрумів, Т34ВГ1 розпіновка")

## Структурна схема

Для побудови Спектрум-сумісного комп'ютера на Т34ВГ1 треба з'єднати між собою відповідні контакти процесора, 16Кб ROM, 64Кб RAM (в ті часи, 8 мікросхем 565РУ5, наприклад), клавіатуру і, при необхідності, Kempston джойстик.  
У схематичному вигляді це можна представити так:

![Архітектура 'чіпсетних' спектрумів, Функціонална схема](/content/2024-08-08-Architecture-Chipset-Based-ZX-Spectrum-Compatible/05-functional-schematic.png "Архітектура 'чіпсетних' спектрумів, Функціонална схема")

## Призначення виводів Т34ВГ1

Усі виходи Т34ВГ1 призначені для роботи з ТТЛ рівнями.

![Архітектура 'чіпсетних' спектрумів, Т34ВГ1 символ](/content/2024-08-08-Architecture-Chipset-Based-ZX-Spectrum-Compatible/06-Т34ВГ1-symbol.png "Архітектура 'чіпсетних' спектрумів, Т34ВГ1 символ")

 - **UCC і 0V** - виводи живлення +5В i GND.

 - **RST** - судячи з усього вхід скидання. Активний при лог.1. В Байті цей вивід постійно підключений до GND.
 
 - **A0-A15** - входи шини адреса. З'єднуються з шиною адреса процесора.
 
 - **D0-D7** - двусторонні линії шини даних. З шиною даних процесора і RAM повинні з'єднуватися через резистори з опором близько 470 Ом - 1К. Для прикладу, можна подивитися підключення шини даних в комп'ютері Байт:

![Архітектура 'чіпсетних' спектрумів, Підключення шини даних](/content/2024-08-08-Architecture-Chipset-Based-ZX-Spectrum-Compatible/07-databus-connection.png "Архітектура 'чіпсетних' спектрумів, Підключення шини даних")

 - **R,G,B,Y,S** - виходи відео. R,G,B - відповідні сигнали кольорів, Y - сигнал яскравості (1-підвищенна, 0-нормальна яскравість), S - синхросигнал. Нагадую - ці сигнали з ТТЛ-рівнями, їх **НЕ МОЖНА** напряму подключати до телевізора!  
На щастя, Байт має вбудовану схему "підмішування" яскравості, тому якихось додаткових змін робити не треба.

 - **AR0-AR7** - виходи адресної шини для подключення динамичної RAM об'ємом 64К. RAM может бути побудовано як з вісьми микросхем КР565РУ5, так і на двух КР565РУ11 (аналог 4464).
 
 - **/RAS, /CAS, /WE** - виходи керуючих сигналів для динамичної RAM. З'єднується з відповідними входами микросхем RAM.
 
 - **/CE** - виход вибора ROM. На ньому з'являється сигнал низького рівня при читанні адресного простіру #0000-#3FFF. При запису даних в цю область #0000-#3FFF, сигнал /CE не формується!  
Цей сигнал повинен підключатися до входу вибора (/CS) мікросхеми ROM. Проте, в залежності від того скільки мікросхем ROM (2х8К, 1х16К або навіть 1х32К) підключення може варіюватися. 
 > Наприклад, в Байті задумувалося використання 2х 8К ROM і розведення було заточене під них, де **/CE** підключається до входів /RD мікросхем, а сигнали /CS - один напряму до А13, а другий через елемент (74LS04) до другої мікросхеми. В мойому варіанті стояла одна мікросхема на 32К, причому на платі були зроблені наступні зміни: /CS мікросхеми ROM був відрізаний від А13 і напряму підключений до землі. Тобто чіп був активний весь час і включав виводи тільки коли **/CE** був активний (низький рівень). Як писав вище, цей сигнал формується тільки, якщо відбувається читання - на запис він не формується.

 - **CLK_IN** - Вхід тактової частоти 8МГц від зовнішнього кварцевого генератора. Напряму сюди кварц підключати не можна! Потрібен генератор по типу такого:

![Архітектура 'чіпсетних' спектрумів, Тактовий генератор для Т34ВГ1](/content/2024-08-08-Architecture-Chipset-Based-ZX-Spectrum-Compatible/08-clock-generator.png "Архітектура 'чіпсетних' спектрумів, Тактовий генератор для Т34ВГ1")


 - **CLK** - вихід частоти 4МГц для клока процесора Z80. Так, при використанні Т34ВГ1 тактова частота процесора буде не 3,5МГц, як у "звичайному" Спектрумі, а 4Мгц. Тактова частота для процессора формується в середені Т34ВГ1 (скоріш за все просто ділиться на два) и подається на процесор.

 - **/INT** - вихід маскуємого переривання. Підключається до відповідного входу процесора. Активний рівень - низький.

 - **/WAIT** - вихід для "зупинки" процесора на час вивода зображення на екран. З'єднується з відповідним входом процесора. Активний рівень - низький.  
 > В архітектурі оригінального Спектрума і його клонів на розсипусі, використовувався підхід з "contended memory", тобто повільною пам'ятю. Це було реалізовано наступним чином - було два набори чипів пам'яті - нижні 16-32К (#4000-#7FFF) і верхні 32К (#8000-#FFFF). Де доступ процесора до нижніої пам'яті гальмувався зупинкою тактів на CLK піні процесора. Доступ до верхньої частини був весь час, тому доступ до верхньої частини вважався швидшим. В випадку з Т34ВГ1 - вся пам'ять буде повільною, оскільки немає розділення на верхню-нижню частини і процесор буде гальмуватися весь час, коли відмальовується екран.

 - **/M1, /IORQ, /MREQ, /RD, /WR, /RFSH** - відповідні входи сигналів з процесора.
 - **KEY1-KEY5** - входи сигналів порта клавіатури. Клавиатурний порт з адресою #FE вже виконаний в середині Т34ВГ1. Достаньо тільки подати на мікросхему сигнали з клавіатури і більше нічого робити не треба. Окрім того входи KEY1-KEY5 треба "підтягнути" до +5В через резистори опором в кілька кілоом. Вхід KEY1 відповідає лінії даних D0 клавіатури, KEY2 - D1 і т.д.  
 > Дешифрація порту теж реалізована в середині Т34ВГ1. Порт выбирається тільки по біту A0 шини даних. Клавіатура буде вибиратися при читанні будь якого парного порта. Це важливо, якщо у комп'ютерs буде використовуватися ще якісь парні порти! Вони будуть "конфліктувати" з портом клавіатури.

 - **TI** - магнітофонний вхід. Відповідає біту D6 порта #FE. Знову ж на цей вхід треба подавати сигнал з ТТЛ рівнем, після вхідного формувача. В середині ВГ1 значення цього біта инвертується. Тобто, при не підключеному вході TI з 6-го біта порта #FE буде читатися 0!

 - **SO, TO** - виходи звука і запису на магнітофон. Відповідають бітам 4 и 3 порта #FE. Дешифрація порта #FE на вивід сзроблена теж тількти по біту A0 шини адреса. Виходи ці мають ТТЛ рівні. Сигнал прямий, не інвертований. Тобто, якщо записати в біти 3 и 4 порта #FE лог.0, то і на виходах SO, TO буде лог.0.

 - **/SSRD** - вихід виборки читання службового порта. Лог.0 на ньому значить, що іде читання порта. Порт вибирається при A0=1 и A7=0. Цей порт в Спектрумах, зроблених на БМК, зазвичай служить для підключення Kempston-джойстика. Для цього потрібно додатковий буфер (наприклад, КР1533АП3, АП5, АП6 і т.д.).

 > Таке використання сигнала /SSRD не зовсім правильне тому, що в його формуванні не бере участі біт A5. Тому джойстик буде "відповідати" на читання будь яких портів, у яких A7=0 и A0=1. По хорошому, треба або доповнити вибірку джойстика по біту A5, або робити свою схему формування читання порта #1F.

- **/SSWR** - вихід запису в службовий порт. Цей порт вибирається при A7=0, A0=1, т.т. по двум бітам шини адреса. В звичайному Спектрумі порт з таким адресом не використовується, тому цей вихід зазвичай нікуди не підключений.


## Карта внутрішніх портів Т34ВГ1

<table style="font-size: 10pt">
<tbody><tr><td colspan="8" align="center">Біти</td>
<td rowspan="2" align="center">Адрес</td>
<td rowspan="2" align="center">Режим</td>
<td rowspan="2" align="center">Опис</td></tr>
<tr><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr>
<tr>
<td style="font-weight:bold;background:lightgray">0</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td style="font-weight:bold;background:lightgray">1</td>
<td>-</td><td>Write</td><td>Службовий порт (/SSWR)</td>
</tr><tr>
<td style="font-weight:bold;background:lightgray">0</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td style="font-weight:bold;background:lightgray">1</td>
<td>-</td><td>Read</td><td>Службовий порт (/SSRD)</td>
</tr><tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td style="font-weight:bold;background:lightgray">0</td>
<td>#FE (254dec)</td><td>Read</td><td>Клавіатура/магнітофон</td>
</tr><tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td style="font-weight:bold;background:lightgray">0</td>
<td>#FE (254dec)</td><td>Write</td><td>Бордюр/звук/вивід на магнітофон</td>
</tr></tbody></table>

Сірим кольором позначені біти, по яким відбувається дешифрація адреса порта.
